<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="main.css"/>
    <meta charset="UTF-8">
    <title>Bubble</title>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>
<body>

<script src="move.min.js"></script>

<div class="wrapper" id="app">
    <div class="sidebar">
        <div class="menu">
            <menu-header :username="username" :balance="balance"></menu-header>
        </div>

        <div class="viewChoice">
            <router-link to="/game" id="gameLink">Game</router-link>
            <router-link to="/farm" id="farmLink">Farm</router-link>
        </div>

        <div class="bottom-bar">
        </div>
    </div>

    <div class="mainView">
        <router-view :token="token"></router-view>
    </div>
</div>

<script>

    Vue.component('menu-header', {

        props : ['username', 'balance'],
        template : `
            <div>
                <h2 id="username">{{username}}</h2>
                <h2 id="balance">{{balance}}</h2>
            </div>`
    });

    const plane = Vue.component('plane', {

        props : ['token'],
        data : function () {
            return {
                bubbles: []
            }
        },
        created : function () {
            setInterval(this.update, 500);
        },
        template : `
            <div class="plane">
                <bubble v-for="b in bubbles" :key="b.id" :posX="b.x" :posY="b.y"></bubble>
            </div>`,

        methods : {
            update : function () {

                axios.request({
                    url : 'http://localhost:8090/bubble/farmState',
                    method : 'get',
                    headers : {
                        'token' : this.token
                    }
                }).then(response => {

                    this.bubbles = response.data.bubbles;
                    this.$emit('updateBalance', Number(response.data.balance));

                }).catch(response => {
                    console.log(response);
                })
            }
        },
    });

    const game = Vue.component('game', {

        data : function () {
            return {
                bubble : {
                    id : -1
                }
            }
        },
        props : ['token'],

        template : `
            <div class="game">
                <div class="outline">
                </div>
                <bub class="mainBubble"/>

            </div>`,
        created : function () {
            this.update();
        },
        methods : {
            update : function () {
                axios.request({
                    url : 'http://localhost:8090/bubble/state',
                    method : 'get',
                    headers : {
                        token : this.token
                    }
                }).then(response => {

                    console.log('callback');
                    newBubble = response.data;
                    if(this.bubble.id != newBubble.id){
                        this.bubble = newBubble;

                        let style = document.createElement('style');
                        style.type = 'text/css';
                        let keyFrames = `
                             @keyframes grow {
                             0% {transform : scale(${this.bubble.progress/100});}
                             100% {transform : scale(${this.bubble.max/100});}
                                }`;
                        style.innerHTML = keyFrames;
                        document.getElementsByTagName('head')[0].appendChild(style);

                        let end = this.bubble.stamp + 70 * this.bubble.max;
                        let dur = end - Date.now();

                        this.style = {
                            animationName : 'grow',
                            animationDuration : dur + 'ms'
                        };


                    } else {
                        setTimeout(this.update, 100);
                    }

                })
            }
        }
    });

    Vue.component('bub', {
       template : `
            <div id="mainBubble" :style="stl"></div>
            `,
        props : ['stl'],

    });

    const routes = [
        { path: '/farm', component: plane },
        { path: '/game', component: game }
    ];

    const router = new VueRouter({routes});

    Vue.component('bubble', {

        props : ['posX', 'posY', 'lifespan'],
        template : `

                <img src="circle.png" v-bind:style="{gridColumn : posX, gridRow : posY}" class="bubbleImage"/>

                `
    });

    Vue.component('main-bubble', {


    });

    var username, token;

    new Vue({

        el : '#app',
        data : {
            username : '',
            balance : 0,
            token : '',
        },
        router : router,
        created : function () {
          this.username = sessionStorage.getItem('username');
          this.token = sessionStorage.getItem('token');
        },
    });

</script>
</body>
</html>